# 0430

> Asyncio, aiohttp를 사용해서 성능 개선을 시도
> 
- 일단 크롤러가 들어간 코드가 업로드 되어 있지 않아서, 그 전 버전에 인증 과정을 제외하고 아마데우스, gemini, map api만 넣은 채로 시도함
- api가 많아져서 그런건지 정확히 모르지만, 검색 속도가 엄청 느려짐. 3분 내외로 끝났던 답변이 5분정도로 증가함
- 비동기를 위해 추가해본 코드(혹시 몰라 test 파일에 추가)
    
    ```python
    template += "\nHuman: {input}\nAssistant:"
    
    # 400 에러가 발생해서 물어보니, "template의 마지막에 "\nHuman: {input}\nAssistant:"를 추가하여 항상 사용자의 입력으로 끝나도록 하였습니다. 이렇게 하면 Google Cloud AI API에서 요구하는 형식을 충족할 수 있습니다." 라고 함
    
    class CustomOutputParser(AgentOutputParser):
    
        def parse(self, llm_output: str) -> Union[AgentAction, AgentFinish]:
            # Check if agent should finish
            if "Final Answer:" in llm_output:
                return AgentFinish(
                    return_values={"output": llm_output.split("Final Answer:")[-1].strip()+"\nHuman: "},
    
    # 중략 
    
    async def async_search_online(input_text):
        async with aiohttp.ClientSession() as session:
            search = await DuckDuckGoSearchRun(session).arun(f"site:tripadvisor.com things to do{input_text}")
        return search.result
    	
    async def async_search_hotel(input_text):
        async with aiohttp.ClientSession() as session:
            search = await DuckDuckGoSearchRun(session).arun(f"site:agoda.com {input_text}")
        return search.result
    
    async def async_search_flight(input_text):
        async with aiohttp.ClientSession() as session:
            search = await DuckDuckGoSearchRun(session).arun(f"site:skyscanner.com {input_text}")
        return search.result
    
    async def async_search_general(input_text):
        async with aiohttp.ClientSession() as session:
            search = await DuckDuckGoSearchRun(session).arun(f"{input_text}")
        return search.result
        
     # 중략
     
     @cl.on_chat_start
    async def agent():
        tools = [
    
            Tool(
                name="Search general",
                func=async_search_general,
                description="useful for when you need to answer general travel questions",
                coroutine=True
            ),
            Tool(
                name="Search tripadvisor",
                func=async_search_online,
                description="useful for when you need to answer trip plan questions",
                coroutine=True
            ),
            Tool(
                name="Search hotel",
                func=async_search_hotel,
                description="useful for when you need to answer hotel questions",
                coroutine=True
            ),
            
         # 중략
         
           async def async_agent_executor(input_text):
    		     return await agent_executor.arun(input_text)
    
        return async_agent_executor, memory
    ```
    
    ```python
    async def run_agent():
            agent_executor, memory = await chatbot_core.agent()
            
    # 중략
    
     if query:
            asyncio.run(run_agent())
    ```
    
- chatbot_core 및 chat_page에 async를 사용해서 시도 중에 403, permisssion denied 발생….
- 웹 검색을 많이 요청해도 덕덕고에서 막혀야하는데 왜 gemini쪽 에서 문제가 생겼는지는 모르겠음
- create_task와 gather를 사용하여 코드를 짜보고 싶지만, 어디부터 건드려야 할 지 잘 모르겠음. 또한 비동기로 들어오는 결과의 데이터 반환값이 달라서 이 부분도 뭔가…. 잘 모르겠음
    - Observation:<coroutine object async_search_online at 0x000002F21E7BBA60>
